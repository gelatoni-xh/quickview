name: Debug SSH & SCP

on:
  workflow_dispatch:  # 手动触发

jobs:
  ssh-debug:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ 拉取代码（可选）
      - uses: actions/checkout@v3

      # 2️⃣ 保存 secrets 的 PEM 到临时文件
      - name: Save PEM to file
        run: |
          echo "${{ secrets.SERVER_PEM }}" > /tmp/debug_key.pem
          chmod 600 /tmp/debug_key.pem
          echo "PEM saved"

      # 3️⃣ 测试 SSH 端口是否可连
      - name: Test SSH port
        run: |
          nc -vz ${{ secrets.SERVER_HOST }} 22 || echo "Port 22 not reachable"

      # 4️⃣ 测试 SSH 登录
      - name: Test SSH connection
        run: |
          ssh -i /tmp/debug_key.pem -o StrictHostKeyChecking=no ubuntu@${{ secrets.SERVER_HOST }} "echo SSH success && whoami && pwd"

      # 5️⃣ 测试 SCP 上传小文件
      - name: Test SCP small file
        run: |
          echo "test file content" > test.txt
          scp -i /tmp/debug_key.pem -P 22 test.txt ubuntu@${{ secrets.SERVER_HOST }}:/home/ubuntu/test.txt
          echo "SCP done"
